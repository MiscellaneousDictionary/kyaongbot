//KyBot 5.0 alpha prerelease build, rgb / firefox
const scriptName="Ky_core.js";

const blank = '‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭‭\n\n\n'

let firstLoad = true
let command = '';
let description = '';
let commandList = new Array();
let descriptionList = new Array();
let userGroup = ['admin', 'manager', 'member'];

const welcomeMessage = ('\n처음 오신 분이라면 공지를 참조하여 인증하시고,\n기존 멤버인데 프로필을 수정하신 것이라면 !인증 <식별코드> 를 입력해 주세요.(<> 괄호는 제외)\인증을 거치지 않으면 일부 기능 이용이 불가능합니다.')


if (DataBase.getDataBase('KyBot') == null) DataBase.setDataBase('KyBot', JSON.stringify(new Object()));
const Ky = JSON.parse(DataBase.getDataBase('KyBot'));

Ky.g = Ky.g || new Object(); //Group 객체
Ky.g.tempAuth = Ky.g.tempAuth || new Object(); //임시 인증 데이터
Ky.g.tempHash = Ky.g.tempHash || new Object(); //임시 인증 데이터
Ky.c = Ky.c || new Object(); //Core 객체


/*아이디어노트

group, room 별 명령어 지원 설정
manageCp
manageGp
한 명령어로 연동 이거 뭐라하더라 중재자패턴인가

var r = org.jsoup.Jsoup.connect("https://www.naver.com/?mobile").get().select('span[class=ah_k]');
var list = [];
for (i=1; i<21; i++){ list.push(i + '. ' + r.get(i).text() + '\n') }
replier.reply(list.join('').slice(0,-1))



*/


eval(DataBase.getDataBase('moment'));


const UPDATE = {};
UPDATE.saveData = function(msg) { //파일에 내용을 저장하는 함수
  try {
    var file = new java.io.File(sdcard + '/kbot/response.js');
    var fos = new java.io.FileOutputStream(file);
    var str = new java.lang.String(msg);
    fos.write(str.getBytes());
    fos.close();
  } catch (e) {
    Log.debug(e + ' At:' + e.lineNumber);
  }
};



var manageDB = function() {
   return {
      loadAll: function() {
            
         }
   }
}


var manageCp = (function() {
   return {
		check: function(params, i) {
			let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
			icode = i || icode;
			return Ky.g[group].m[icode].cp;
		},
		add: function(params, point, i) {
			let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
			icode = i || icode;
			return Ky.g[group].m[icode].cp += point;
		}
	};
})();


var manageMember = (function() {
   return {
      //icodeMigration: function(group, sender) {
         
      //}
      memberMigration: function(params) {
         let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
         Ky.g[group].memberList.splice(Ky.g[group].icodeList.indexOf(Ky.g[group].tempM[sender].mayBe),1, sender);
         Ky.g[group].m[Ky.g[group].icodeList[Ky.g[group].memberList.indexOf(sender)]] = sender;
         memberListSort(group);
      },
      hashMigration : function(params) {
         let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
         Ky.g[group].hashList.splice(Ky.g[group].hashList.indexOf(Ky.g[group].m[Ky.g[group].tempM[sender].mayBe].hash), 1, hash);
         memberListSort(group);
      }
   };
})();

var miniGame = (function() {
   return {
      
   };
})();


function getHash(params) {
   let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
   return java.lang.String(imageDB.getProfileImage()).hashCode();
}

function makeAuthID() {
   var text = "";
   var possible = "abcdefghijklmnopqrstuvwxyz0123456789";
   for( var i=0; i < 6; i++ ) text += possible.charAt(Math.floor(Math.random() * possible.length));
   return text;
}

var Group = (function() { //Group 생성자 | ex) Ky.g[group] = new Group(group);
   function Group() {
      this.counter = new Object();
      this.counter.total = 0;
      this.r = new Object();
      this.m = new Object();
      this.tempM = new Object();
      this.icodeList = new Array();
      this.memberList = new Array();
      this.hashList = new Array();
      this.roomList = new Array();
      this.admin = new Array();
   };
   return Group;
})();

var Room = (function() { //Room 생성자
   function Room(params) {
      let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params
      this.groupName = group;
      Ky.g[group].roomList.push(room);
   }
   Room.prototype.botOn = true;
   return Room;
})();

var Member = (function () { //Member 생성자
   function Member(params){
      let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params
      this.group = group;
      this.member = sender;
      this.hash = hash;
      this.counter = new Object();
      this.counter.total = 0;
      this.type = userGroup[userGroup.length - 1];
      this.warningW = 0;
      this.cp = 0;
      this.gp = 0;
   };
   return Member;
})();

function randomIcode(params) {
   let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params
   var possible = "0123456789";
   while (true) {
      var text = "";
      for(var i=0; i < 4; i++) text += possible.charAt(Math.floor(Math.random() * possible.length));
      if (Ky.g[group].icodeList.indexOf(String(text)) == -1) break;
   }
   return text;
}

function memberListSort(params) {
   let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params
   var tb = escape(JSON.stringify(Ky.g[group].memberList));
   var ta2 = [];
   Ky.g[group].memberList.sort();
   var ta = JSON.parse(unescape(tb));
   for (var i = 0; i < Ky.g[group].icodeList.length; i++) {
      ta2.push(Ky.g[group].icodeList[ta.indexOf(Ky.g[group].memberList[i])]);
   }
   Ky.g[group].icodeList = ta2;
}

function memberCounter(params) {
	let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
	var t = moment().format('YYMMDDHH');
	Ky.g[group].m[icode].counter.timeList = Ky.g[group].m[icode].counter.timeList || new Array();
	Ky.g[group].m[icode].counter.list = Ky.g[group].m[icode].counter.list || new Array();
	var timeList = Ky.g[group].m[icode].counter.timeList
	if (timeList.indexOf(t) == -1) timeList.push(t);
	Ky.g[group].m[icode].counter.list[timeList.indexOf(t)] = Ky.g[group].m[icode].counter.list[timeList.indexOf(t)] || 0
	Ky.g[group].m[icode].counter.list[timeList.indexOf(t)]++;
	Ky.g[group].m[icode].counter.total = Ky.g[group].m[icode].counter.total || 0;
	Ky.g[group].m[icode].counter.total++;
	//replier.reply(Ky.g[group].m[icode].counter.total)
}





function memberCount(params, input, code) {
   let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
icode = code || icode
   if (input.indexOf('-') != -1) {
var from = moment(input.split('-')[0], ['YYMMDDHH', 'YYMMDD', 'YYDD', 'YY'], true);
      if (moment(input.split('-')[0], ['YYMMDDHH', 'YYMMDD', 'YYDD', 'YY'], true).isValid()) {
      } else return '숫자만 입력해 주세요.';
         var to = moment(input.split('-')[1], ['YYMMDDHH', 'YYMMDD', 'YYDD', 'YY'], true);
      if (to.isValid()) {
         if (input.split('-')[1].length == 2) to.endOf('year');
         if (input.split('-')[1].length == 4) to.endOf('month');
         if (input.split('-')[1].length == 6) to.endOf('day');
         if (input.split('-')[1].length == 8) to.endOf('hour');
      } else return '숫자만 입력해 주세요.';
   if (to.diff(from) < 0) return '시작 시간, 종료 시간 순으로 입력해 주세요.';
      if (to.diff(from.add(1, 'y')) > 0) return '최대 구간 길이는 1년입니다.';
	from.add(-1, 'y');
	} else {
	if (moment(input, ['YYMMDDHH', 'YYMMDD', 'YYDD', 'YY'], true).isValid()) {
         var from = moment(input, ['YYMMDDHH', 'YYMMDD', 'YYDD', 'YY'], true);
      } else return '숫자만 입력해 주세요.';
      var to = moment();
      if (to.diff(from) < 0) return '시작 시간은 현재 시간 이전이여야 합니다.';
	}
	
	var result = 0;
	var timeList = Ky.g[group].m[icode].counter.timeList || new Array();
	var t = from.format('YYMMDDHH');
	//replier.reply(t)
	var a1 = Number(t.slice(0,2));
	var a2 = Number(t.slice(2,4));
	var a3 = Number(t.slice(4,6));
	var a4 = Number(t.slice(6,8));
	//var a0 = Number(t.slice(0,6));
	for(i=0; i<timeList.length; i++) {
		var t = timeList[i];
		//replier.reply(t)
		var b1 = Number(t.slice(0,2));
		var b2 = Number(t.slice(2,4));
		var b3 = Number(t.slice(4,6));
		var b4 = Number(t.slice(6,8));
		if (a1<=b1) { if (a2<=b2) { if (a3<=b3) { if (a4<=b4) {
			var start = i
			//replier.reply('✔')
			break;
		}}}}
	}
	if (typeof start == 'undefined') start = -1;
	if (start == -1) return 0;
	var n = start += 0
	var t = to.format('YYMMDDHH')
	var a1 = Number(t.slice(0,2));
	var a2 = Number(t.slice(2,4));
	var a3 = Number(t.slice(4,6));
	var a4 = Number(t.slice(6,8));
	for (i=n; i<timeList.length; i++) {
		var t = timeList[i];
		//replier.reply('t')
		var b1 = Number(t.slice(0,2));
		var b2 = Number(t.slice(2,4));
		var b3 = Number(t.slice(4,6));
		var b4 = Number(t.slice(6,8));
		if (a1<=b1) { if (a2<=b2) { if (a3<=b3) { if (a4<=b4) {
			var end = i
			break;
		}}}}
	}
	//replier.reply('end: ' + end)
	if (typeof end == 'undefined') end = timeList.length - 1;
	//replier.reply('start: ' + start);
	//replier.reply('end: ' + end)
	var list = Ky.g[group].m[icode].counter.list;
	for (i=start; i<end+1; i++) {
		result += list[i];
		//replier.reply(timeList[i]);
	}
	//replier.reply('hi')

//replier.reply( new Date().getTime()-timea)
   return result;
   } 

function lolStat(nick) {
   var mmr = true, unranked = false
   try{
      var doc = org.jsoup.Jsoup.connect("http://www.op.gg/summoner/userName=" + nick).         header("Accept-Language", "ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7").get();
      try{
         var doc1 = org.jsoup.Jsoup.connect("http://www.op.gg/summoner/ajax/mmr/summonerName=" + nick).header("Accept-Language", "ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7").get();
      } catch (e) { //결과값을 찾을수 없으면
         mmr = false
      }
      if (doc.select('div.Tier').get(0).text() == 'Unranked') unranked = true
      var arr = [];
      for (i = 0; i < 3; i++) {
         if (doc.select('.ChampionBox:eq(' + i + ') a').text() == '') break;
         arr.push(' ' + doc.select('.ChampionBox:eq(' + i + ') a').text());
         arr.push(' : ');
         arr.push(doc.select('.ChampionBox:eq(' + i + ') div.title').text());
         arr.push(', KDA ');
         arr.push(doc.select('.ChampionBox:eq(' + i + ') span.KDA').text());
         arr.push(', ');
         arr.push(doc.select('.ChampionBox:eq(' + i + ') div[title=승률]').text());
         arr.push('\n');
      }
      var list = arr.join(''), arr = [];
      arr.push('[' + doc.select("div.SummonerName").text() + ']\n');
      if (!unranked) arr.push(doc.select('div.LadderRank').text() + '\n');
      arr.push('| LV ' + doc.select('span[class=Level tip]').text()+ ' | ');
      if(!unranked) { arr.push(doc.select('div.Tier').get(0).text() + ' | ' + doc.select('div.LP').get(0).text() + ' |') } else arr.push('Unranked |')
      if (doc.select('div div span.Item').text() != '') arr.push('\n[ ' + doc.select('div div span.Item').text() + ' ]');
      arr.push('\n\n》최근 20게임 전적\n ' + doc.select('div.WinRatioTitle span.win').text() + '승 ' +       doc.select('div.WinRatioTitle span.lose').text() + '패, ' + doc.select('div.WinRatioTitle b').text());
      if (!unranked) arr.push('\n》솔랭 전적\n ' + doc.select('div.WinLose').get(0).text());
      arr.push('\n》MOST 챔피언\n' + list);
      if (mmr) arr.push('\n예상 MMR : ' + doc1.select('td.MMR').text() + '\n예상 티어 : ' + doc1.select('td.TierRankString').text());
      if (mmr) if (doc1.select('div.TipStatus').text() != '') arr.push('\n' + doc1.select('div.TipStatus').text());
      return arr.join('')
   } catch (e) { //결과값을 찾을수 없으면
      return("전적 정보가 없습니다.");
   }
}

function response(room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId){
   let params = { //함수용 통합 매개변수
      get room () { return room; },
      get msg () { return msg; },
      get sender () { return sender; },
      get isGroupChat () { return isGroupChat; },
      get replier () { return replier; },
      get imageDB () { return imageDB; },
      get packageName () { return packageName; },
      get threadId () { return threadId; }
   }
   
   //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   //Authentification // 신규 데이터 생성, 인증 발급
   //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   
   
   //개인톡 인증
   if (isGroupChat == false) {
      if (msg in Ky.g) {
         var group = msg;
      } else if (sender in Ky.g.tempAuth) {
         var group = Ky.g.tempAuth[sender];
      } else return;
      if (sender in Ky.g[group].tempM) {
         var authID = makeAuthID();
         Ky.g[group].tempM[sender].authID = authID;
         Ky.g.tempAuth[authID] = group;
         Ky.g.tempHash[authID] = getHash(params);
         replier.reply('인증코드:');
         replier.reply(authID);
         replier.reply('닉네임:');
         replier.reply(sender);
         replier.reply('인증코드를 복사해서 공지에 있는 2차 인증센터에 들어갈때 <<카카오프렌즈>> 선택 후 <<닉네임에 붙여넣으세요>>. 방에 입장한 후에는 닉네임을 복사해서 그대로 붙여넣어 채팅을 보내면 인증이 완료됩니다.\n헷갈리지 마세요. <<닉네임을 인증코드로>> 하셔야 합니다. <<닉네임을 인증코드>>.');
      } else if (msg in Ky.g[group].tempM) {
         if (sender == Ky.g[group].tempM[msg].authID) {
            params = { //함수용 통합 매개변수
               get group () { return group; },
               get hash () { return hash; }
            }
            var icode = randomIcode(params);
            Ky.g[group].m[icode] = new Member(params);
            Ky.g[group].m[icode].authID = sender;
            Ky.g[group] = Ky.g[group] || new Object(params);
            Ky.g[group].memberList.push(msg);
            Ky.g[group].hashList.push(Ky.g.tempHash[sender]);
            Ky.g[group].icodeList.push(icode);
            if (Ky.g[group].memberList.length == 1) {
               Ky.g[group].m[icode].type = userGroup[0];
               replier.reply('최초 관리자로 등록되었습니다.');
            }
             memberListSort(params);
            replier.reply('인증 성공. 데이터베이스가 정상적으로 생성되었습니다. 이제 자유로운 캬옹봇 사용이 가능합니다.')
            replier.reply('식별코드: ' + icode)
            delete Ky.g[group].tempM[msg];
         } else replier.reply('인증 실패, 다시 시도해 보세요.')
      }
      return;
   }
   
   //단체톡 시작
   var roomFullName = room;
   var group = room.split('_')[0];
   var room = roomFullName.split('_')[1];
   var hash = getHash(params);
   

	Object.defineProperty(params, "group", { get: function () { return group; } });
	Object.defineProperty(params, "hash", { get: function () { return hash; } });
	
   Ky.g[group] = Ky.g[group] || new Group(params);
   Ky.g[group].r[room] = Ky.g[group].r[room] || new Room(params);
   if (Ky.g[group].roomList.indexOf(room) == -1) Ky.g[group].roomList.push(room);
   
   for (i=0; i<Ky.g[group].roomList[i]; i++) {
      if (Ky.g[group].r[Ky.g[group].roomList[i]].botOn == false) return; 
   }
   
   var unAuthed = false;
   if (Ky.g[group].memberList.indexOf(sender) == -1 || Ky.g[group].hashList.indexOf(hash) == -1) {
      Ky.g[group].tempM[sender] = Ky.g[group].tempM[sender] || new Object();
      Ky.g[group].tempM[sender].alert = Ky.g[group].tempM[sender].alert || 't';
      if ('mayBe' in Ky.g[group].tempM[sender]) {
         if (msg == Ky.g[group].tempM[sender].authCode) {
            if (Ky.g[group].hashList.indexOf(hash) == -1) manageMember.hashMigration(params);
            if (Ky.g[group].memberList.indexOf(sender) == -1) manageMember.memberMigration(params);
            replier.reply('계정 이전이 완료되었습니다.');
            delete Ky.g[group].tempM[msg];
         } else {
			if (msg == !인증취소) {
				delete Ky.g[group].tempM[sender].mayBe;
				delete Ky.g[group].tempM[sender].authCode;
				replier.reply('인증이 취소되었습니다.');
			} else replier.reply('인증센터로 전송된 인증번호를 입력해 주세요. 인증번호를 받을 수 없다면 관리자에게 문의하세요.');
         }
      } else if (msg.substr(0, 4) == '!인증 ' && Ky.g[group].icodeList.indexOf(msg.substr(4)) != -1) {
         var aCode = makeAuthID();
         Ky.g[group].tempM[sender].mayBe = msg;
         Ky.g[group].tempM[sender].authCode = aCode;
         Api.replyRoom(Ky.g[group].m[msg].authID, aCode);
         Api.replyRoom(group + '_관리방', '[' + sender + '] 인증코드: ' + aCode);
         replier.reply(aCode);
         
         replier.reply('인증코드가 인증센터로 전송되었습니다.');
      } else if (Ky.g[group].tempM[sender].alert == 't') {
          replier.reply('[' + sender + ']님 어서오세요.\n아래 내용을 펼쳐 안내를 확인하세요.' + blank + welcomeMessage);
         Ky.g[group].tempM[sender].alert = 'f';
      }
      var unAuthed = true;
   }
   if (unAuthed == true) {
   	var icode = 'unauth'
   } else var icode = Ky.g[group].icodeList[Ky.g[group].memberList.indexOf(sender)];
	Object.defineProperty(params, "icode", { get: function () { return icode; } });
   
   if (icode != 'unauth' && Ky.g[group].m[icode].counter.total == 0) replier.reply('[' + sender + ']님,' + group + '에 오신 것을 환영합니다. 공지 또는 홈페이지에서 명령어를 확인하세요. <!식별코드> 로 식별코드를 확인하세요.')

   if (Ky.g[group].admin.indexOf(icode) != -1) {
      
      
      if (msg == "!업데이트") {
    UPDATE.saveData(getHtml('https://raw.githubusercontent.com/chanoo104/kyaongbot/master/response.js'));
    replier.reply("[업데이트 코멘트]\n" + getHtml("https://github.com/chanoo104/kyaongbot/commit/master").split('<p class="commit-title">')[1].split("</p>")[0].trim());
    Api.reload();
    if (error == false) {
      replier.reply('업데이트 성공!')
    } else if (error == true) {
      replier.reply('업데이트 실패..')
    }
}
if (msg == '!리로드') {
    Api.reload();
    replier.reply('리로드 성공!');
}

if (msg == "!로드") {
    replier.reply("백업 진행중...");
    Ky = JSON.parse(DataBase.getDataBase("KyBot_backup0"));
}
if (msg == "!세이브") {
    replier.reply("진행중...");
    DataBase.setDataBase(JSON.stringify(Ky), "KyBot_backup0");
}
   }
   
   Ky.g[group].enabled = Ky.g[group].enabled || new Object();
   
   Ky.g[group].enabled.miscSys = Ky.g[group].enabled.miscSys || true;
   if (Ky.g[group].enabled.pDBSys = true){
      pDBSys(params);
   }
   
   Ky.g[group].enabled.cpSys = Ky.g[group].enabled.cpSys || true;
   if (Ky.g[group].enabled.cpSys = true){
      cpSys(params);
   }
   
   Ky.g[group].enabled.miniGameSys = Ky.g[group].enabled.miniGameSys || true;
   if (Ky.g[group].enabled.miniGameSys = true){
      miniGameSys(params);
   }
   
   Ky.g[group].enabled.miscSys = Ky.g[group].enabled.miscSys || true;
   if (Ky.g[group].enabled.miscSys = true){
      miscSys(params);
   }
   
   Ky.g[group].enabled.memberCounter = Ky.g[group].enabled.memberCounter || true;
   if (icode != 'unauth'){
   if (Ky.g[group].enabled.memberCounter = true){
      memberCounter(params);
   }
   Ky.g[group].m[icode].cp ++;
   }
   
   
   
   firstLoad = false;



}





function commandChk(params, c, a, d) {
	let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
	if (icode == 'unauth' && a != 'all') {
		return false;
	}
	if (icode != 'unauth') {
	if (userGroup.indexOf(a) < userGroup.indexOf(Ky.g[group].m[icode].type)) return false;
	Ky.g[group].enabled[command] = Ky.g[group].enabled[command] || true;
	if (Ky.g[group].enabled[command] == false) {
		return false;
	}
	}
	Ky.g[group].counter[command] = Ky.g[group].counter[command]++ || 0;
	if (msg == '!명령어') {
		commandList.push(command);
		descriptionList.push(description);
	}
	return true;
}
let c, a, d;


function manageSys(params) {
   //관리용 시스템/명령어
   let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
   
}

function pDBSys(params) {
   //미니게임 제외 개인 데이터 관련 시스템/명령어
   let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
   
   
   
   //이런식으로


   
}

function cpSys(params) {
   //미니게임 제외 포인트 관련 시스템/명령어
   let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
   loop: {
   c = '!테스트'
   a = 'all'
   d = '테스트입니다.'
   if(commandChk(params, c, a, d) == false) break loop;
   if (msg == c) {
   	replier.reply('✔');
   }}
   loop: {
   c = '!식별코드'
   a = 'all'
   d = '.'
   if(commandChk(params, c, a, d) == false) break loop;
   if (msg == c) {
   	replier.reply(icode);
   }}
   loop: {
   c = '!포인트'
   a = 'member'
   d = '자신의 포인트를 출력합니다.'
   if(commandChk(params, c, a, d) == false) break loop;
   if (msg == c) {
   	replier.reply(manageCp.check(params));
   }}
}

function miniGameSys(params) {
   //미니게임 관련 시스템/명령어
   let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
   
}

function miscSys(params) {
   //잡다한 시스템/명령어
   let {room, msg, sender, isGroupChat, replier, imageDB, packageName, threadId, group, hash, icode} = params;
   
}





function onStartCompile(){
    /*컴파일 또는 Api.reload호출시, 컴파일 되기 이전에 호출되는 함수입니다.
     *제안하는 용도: 리로드시 자동 백업*/
    DataBase.setDataBase('KyBot', JSON.stringify(Ky));
    Api.gc();
}
